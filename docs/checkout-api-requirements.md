# ç»“ç®—é¡µé¢åç«¯APIéœ€æ±‚æ–‡æ¡£

## å½“å‰çŠ¶æ€
æ ¹æ® `naicha-openapi.json` åˆ†æï¼Œç›®å‰è®¢å•ç›¸å…³APIåŒ…æ‹¬ï¼š
- `POST /api/v1/orders/preview` - è®¢å•ä»·æ ¼é¢„è§ˆ
- `POST /api/v1/orders` - åˆ›å»ºè®¢å•
- `GET /api/v1/orders/{order_id}` - è·å–è®¢å•è¯¦æƒ…

## éœ€è¦æ·»åŠ /å®Œå–„çš„å­—æ®µ

### 1. åˆ›å»ºè®¢å•è¯·æ±‚å‚æ•° (POST /api/v1/orders)

å½“å‰APIæ–‡æ¡£ä¸­æœªæ˜ç¡®æ˜¾ç¤ºè¯·æ±‚ä½“schemaï¼Œéœ€è¦åç«¯ç¡®è®¤æˆ–æ·»åŠ ä»¥ä¸‹å­—æ®µï¼š

```typescript
interface CreateOrderRequest {
  // ç°æœ‰å­—æ®µï¼ˆæ¨æµ‹ï¼‰
  items: OrderItem[];
  delivery_type: 'pickup' | 'delivery';
  shop_id: number;
  notes?: string;
  
  // ğŸ†• éœ€è¦æ·»åŠ çš„å­—æ®µ
  dining_type?: 'dine-in' | 'takeout';  // å°±é¤æ–¹å¼ï¼ˆåº—å†…å°±é¤/æ‰“åŒ…å¸¦èµ°ï¼‰
  pickup_time?: string;                  // é¢„çº¦å–é¤æ—¶é—´ (ISOæ ¼å¼æˆ–ç‰¹æ®Šå€¼"now")
  phone: string;                         // é¢„ç•™æ‰‹æœºå·ï¼ˆå¿…å¡«ï¼‰
  
  // å¤–å–ç›¸å…³ï¼ˆç°æœ‰ï¼‰
  address_id?: number;
  
  // ä¼˜æƒ ç›¸å…³ï¼ˆç°æœ‰ï¼‰
  coupon_id?: number;
  use_points?: boolean;
}
```

**ä¸šåŠ¡é€»è¾‘è¯´æ˜**ï¼š
- `dining_type` ç”¨äºåŒºåˆ†åº—å†…å°±é¤å’Œæ‰“åŒ…å¸¦èµ°ï¼Œå½±å“å–é¤ç æ˜¾ç¤ºé€»è¾‘
- `pickup_time` æ”¯æŒé¢„çº¦å–é¤ï¼Œå€¼ä¸º "now" æˆ– ISOæ—¶é—´å­—ç¬¦ä¸²
- `phone` ä½œä¸ºè®¢å•è”ç³»æ–¹å¼ï¼Œç”¨äºå–é¤é€šçŸ¥

### 2. è®¢å•å“åº”å¢å¼º (OrderResponseSchema)

å½“å‰ `OrderResponseSchema` å·²åŒ…å« `pickup_code`ï¼ˆå–é¤ç ï¼‰ï¼Œä½†éœ€è¦ç¡®è®¤ï¼š

```typescript
interface OrderResponseSchema {
  // ... ç°æœ‰å­—æ®µ
  pickup_code?: string;  // âœ… å·²å­˜åœ¨
  
  // ğŸ” éœ€è¦ç¡®è®¤çš„é€»è¾‘
  // 1. pickup_code æ˜¯å¦æ ¹æ® dining_type åŒºåˆ†ï¼Ÿ
  //    - åº—å†…å°±é¤ï¼šæ˜¾ç¤ºä¸º"å ‚é£Ÿç "
  //    - æ‰“åŒ…å¸¦èµ°ï¼šæ˜¾ç¤ºä¸º"å–é¤ç "
  // 2. pickup_code ä½•æ—¶ç”Ÿæˆï¼Ÿè®¢å•åˆ›å»ºæ—¶è¿˜æ˜¯åˆ¶ä½œå®Œæˆæ—¶ï¼Ÿ
}
```

### 3. é¢„çº¦å–é¤æ—¶é—´é™åˆ¶ (å¯é€‰æ–°å¢API)

å»ºè®®æ–°å¢APIæˆ–åœ¨ç°æœ‰APIä¸­è¿”å›å¯é¢„çº¦æ—¶é—´èŒƒå›´ï¼š

```typescript
// æ–¹æ¡ˆ1: åœ¨åº—é“ºä¿¡æ¯APIä¸­è¿”å›
GET /api/v1/shops/{shop_id}
Response: {
  // ... ç°æœ‰å­—æ®µ
  pickup_time_config: {
    enabled: boolean;
    max_advance_hours: number;  // æœ€å¤šæå‰å¤šå°‘å°æ—¶é¢„çº¦ï¼ˆå¦‚12ï¼‰
    interval_minutes: number;    // æ—¶é—´é—´éš”ï¼ˆå¦‚15åˆ†é’Ÿï¼‰
    blackout_periods?: Array<{  // ä¸å¯é¢„çº¦æ—¶æ®µï¼ˆå¯é€‰ï¼‰
      start: string;  // "HH:MM"
      end: string;
    }>;
  }
}

// æ–¹æ¡ˆ2: æ–°å¢ä¸“ç”¨API
GET /api/v1/shops/{shop_id}/available-pickup-times
Response: {
  times: Array<{
    value: string;      // ISOæ—¶é—´æˆ–"now"
    label: string;      // æ˜¾ç¤ºæ–‡æ¡ˆ
    available: boolean; // æ˜¯å¦å¯é€‰
  }>
}
```

### 4. æ‰‹æœºå·è·å–/éªŒè¯

å°ç¨‹åºç«¯è°ƒç”¨å¾®ä¿¡ `getPhoneNumber` åï¼Œéœ€è¦åç«¯æ¥å£è§£å¯†ï¼š

```typescript
// å¯èƒ½å·²å­˜åœ¨äºç”¨æˆ·æ¨¡å—
POST /api/v1/auth/wechat/phone
Request: {
  code: string;  // å¾®ä¿¡è¿”å›çš„code
}
Response: {
  phone: string; // è§£å¯†åçš„æ‰‹æœºå·
}
```

æˆ–è€…ç›´æ¥åœ¨åˆ›å»ºè®¢å•æ—¶æä¾›æ˜æ–‡æ‰‹æœºå·ï¼ˆå¦‚æœåç«¯å…è®¸ï¼‰ã€‚

## ä»·æ ¼è®¡ç®—ç›¸å…³

å½“å‰ `OrderCalculateResponseSchema` å·²åŒ…å«ï¼š
- âœ… `delivery_fee` - é…é€è´¹
- âœ… `coupon_discount` - ä¼˜æƒ åˆ¸æŠ˜æ‰£
- â“ `packaging_fee` - **åŒ…è£…è´¹** (éœ€è¦ç¡®è®¤æ˜¯å¦åŒ…å«åœ¨breakdownä¸­)

å»ºè®®ï¼š
- å¦‚æœåŒ…è£…è´¹æ˜¯å•ç‹¬é¡¹ï¼Œå»ºè®®åœ¨ `OrderCalculateResponseSchema` ä¸­æ·»åŠ  `packaging_fee: number` å­—æ®µ
- æˆ–è€…åœ¨ `breakdown` æ•°ç»„ä¸­æ·»åŠ  `type: 'packaging'` ç±»å‹

## å®ç°ä¼˜å…ˆçº§

### P0 (å¿…é¡»)
1. âœ… `phone` å­—æ®µæ”¯æŒï¼ˆåˆ›å»ºè®¢å•å¿…å¡«ï¼‰
2. âœ… `dining_type` å­—æ®µæ”¯æŒï¼ˆåŒºåˆ†å°±é¤æ–¹å¼ï¼‰
3. âœ… `pickup_code` è¿”å›é€»è¾‘ç¡®è®¤

### P1 (é‡è¦)
4. â³ `pickup_time` é¢„çº¦æ—¶é—´æ”¯æŒ
5. â³ å¯é¢„çº¦æ—¶é—´èŒƒå›´API

### P2 (ä¼˜åŒ–)
6. â³ å¾®ä¿¡æ‰‹æœºå·è§£å¯†API
7. â³ åŒ…è£…è´¹å•ç‹¬å­—æ®µ

## å‰ç«¯å½“å‰å®ç°

å‰ç«¯å·²æŒ‰ç…§ä»¥ä¸Šéœ€æ±‚å®ç°UIå’Œé€»è¾‘ï¼Œå½“å‰å‚æ•°ä¼ é€’å¦‚ä¸‹ï¼š

```typescript
// checkout.ts onSubmitOrder()
const orderData = {
  items: [...],
  delivery_type: deliveryType,
  dining_type: diningType,        // ğŸ†• æ–°å¢
  pickup_time: pickupTimeValue,   // ğŸ†• æ–°å¢
  shop_id: shopInfo?.id || 1,
  notes,
  phone: userPhone,               // ğŸ†• æ–°å¢
};
```

åç«¯éœ€è¦åŒæ­¥æ”¯æŒè¿™äº›å­—æ®µçš„æ¥æ”¶å’Œå¤„ç†ã€‚

## æµ‹è¯•å»ºè®®

1. **å°±é¤æ–¹å¼æµ‹è¯•**ï¼š
   - åˆ›å»º"åº—å†…å°±é¤"è®¢å•ï¼ŒéªŒè¯å–é¤ç æ˜¾ç¤ºä¸º"å ‚é£Ÿç "
   - åˆ›å»º"æ‰“åŒ…å¸¦èµ°"è®¢å•ï¼ŒéªŒè¯å–é¤ç æ˜¾ç¤ºä¸º"å–é¤ç "

2. **é¢„çº¦æ—¶é—´æµ‹è¯•**ï¼š
   - ç«‹å³å–é¤ï¼š`pickup_time: "now"`
   - é¢„çº¦30åˆ†é’Ÿåï¼š`pickup_time: "2025-11-27T22:00:00+08:00"`

3. **æ‰‹æœºå·æµ‹è¯•**ï¼š
   - å¿…å¡«æ ¡éªŒ
   - æ ¼å¼æ ¡éªŒï¼ˆ11ä½æ•°å­—ï¼‰

## å¤‡æ³¨

- å‰ç«¯æ—¶é—´é€‰æ‹©å™¨é»˜è®¤ç”Ÿæˆæœªæ¥12å°æ—¶å†…æ¯15åˆ†é’Ÿçš„æ—¶é—´æ®µï¼Œåç«¯åº”éªŒè¯æ—¶é—´æ˜¯å¦åœ¨å…è®¸èŒƒå›´å†…
- å¦‚æœåç«¯å·²æœ‰éƒ¨åˆ†å­—æ®µä½†å‘½åä¸åŒï¼Œè¯·å‘ŠçŸ¥å‰ç«¯è°ƒæ•´
