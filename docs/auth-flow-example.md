# ğŸ” ç™»å½•æµç¨‹ä¼˜åŒ–ç¤ºä¾‹

## ğŸ“‹ å˜æ›´è¯´æ˜

å·²å°†ç™»å½•æµç¨‹ä»"å¯åŠ¨æ—¶å¼ºåˆ¶ç™»å½•"æ”¹ä¸º"éœ€è¦æ—¶æ‰ç™»å½•"ï¼Œç¬¦åˆå¾®ä¿¡å°ç¨‹åºçš„æœ€ä½³å®è·µã€‚

### âœ… æ–°æµç¨‹
```
ç”¨æˆ·æ‰“å¼€å°ç¨‹åº 
  â†’ ç›´æ¥è¿›å…¥èœå•é¡µï¼ˆæ— éœ€ç™»å½•ï¼‰
  â†’ æµè§ˆèœå•ã€åŠ è´­ç‰©è½¦ï¼ˆæ— éœ€ç™»å½•ï¼‰
  â†’ ç‚¹å‡»"å»ç»“ç®—"æ—¶æ£€æŸ¥ç™»å½•
  â†’ æœªç™»å½•åˆ™è·³è½¬ç™»å½•é¡µ
  â†’ ç™»å½•æˆåŠŸåè¿”å›ç»“ç®—é¡µ
```

---

## ğŸ”§ å¦‚ä½•åœ¨é¡µé¢ä¸­ä½¿ç”¨

### 1. åœ¨éœ€è¦ç™»å½•çš„é¡µé¢å…¥å£æ£€æŸ¥ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šç»“ç®—é¡µã€æ”¯ä»˜é¡µã€è®¢å•é¡µã€ä¸ªäººä¸­å¿ƒç­‰

```tsx
// src/pages/checkout/index.tsx
import { useEffect } from 'react'
import { requireLogin } from '@/services/auth'

export default function Checkout() {
  useEffect(() => {
    // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç™»å½•çŠ¶æ€
    if (!requireLogin()) {
      // æœªç™»å½•ä¼šè‡ªåŠ¨è·³è½¬ç™»å½•é¡µï¼Œç™»å½•æˆåŠŸåä¼šè¿”å›è¿™é‡Œ
      return
    }
    
    // å·²ç™»å½•ï¼Œç»§ç»­æ‰§è¡Œé¡µé¢é€»è¾‘
    // loadCheckoutData()
  }, [])
  
  return <View>...</View>
}
```

### 2. åœ¨æŒ‰é’®ç‚¹å‡»æ—¶æ£€æŸ¥ï¼ˆæ¨èï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šè´­ç‰©è½¦çš„"å»ç»“ç®—"æŒ‰é’®ã€å•†å“è¯¦æƒ…çš„"ç«‹å³è´­ä¹°"æŒ‰é’®

```tsx
// src/pages/menu/components/CartBar.tsx
import { requireLogin } from '@/services/auth'
import Taro from '@tarojs/taro'

const handleCheckout = () => {
  // æ£€æŸ¥ç™»å½•
  if (!requireLogin('/pages/checkout/index')) {
    return // æœªç™»å½•ä¼šè·³è½¬ç™»å½•é¡µï¼Œç™»å½•æˆåŠŸåä¼šè·³è½¬åˆ°ç»“ç®—é¡µ
  }
  
  // å·²ç™»å½•ï¼Œè·³è½¬ç»“ç®—é¡µ
  Taro.navigateTo({ url: '/pages/checkout/index' })
}
```

### 3. åœ¨ API è°ƒç”¨å‰æ£€æŸ¥ï¼ˆå¯é€‰ï¼‰

**é€‚ç”¨åœºæ™¯**ï¼šæäº¤è®¢å•ã€æ”¯ä»˜ç­‰å…³é”®æ“ä½œ

```tsx
// src/services/order.ts
import { requireLogin } from '@/services/auth'

export async function createOrder(params: CreateOrderParams) {
  // æ“ä½œå‰å†æ¬¡ç¡®è®¤ç™»å½•çŠ¶æ€
  if (!requireLogin()) {
    throw new Error('éœ€è¦ç™»å½•')
  }
  
  return request({
    url: '/api/v1/orders',
    method: 'POST',
    data: params
  })
}
```

---

## ğŸ“ æ–‡ä»¶å˜æ›´æ¸…å•

### 1. `src/app.ts`
- âœ… ç§»é™¤å¯åŠ¨æ—¶çš„å¼ºåˆ¶ç™»å½•æ£€æŸ¥
- âœ… æ”¹ä¸ºé™é»˜å°è¯•ç™»å½•ï¼ˆä¸é˜»å¡æµç¨‹ï¼‰

### 2. `src/services/auth.ts`
- âœ… æ‰©å±• `PUBLIC_ROUTES`ï¼ŒåŠ å…¥èœå•é¡µç­‰æµè§ˆé¡µé¢
- âœ… æ–°å¢ `PROTECTED_ROUTES`ï¼Œå®šä¹‰éœ€è¦ç™»å½•çš„é¡µé¢
- âœ… æ–°å¢ `isProtectedPage()` å‡½æ•°
- âœ… æ–°å¢ `requireLogin()` å‡½æ•°ï¼Œç”¨äºæ£€æŸ¥å¹¶æ‹¦æˆªæœªç™»å½•ç”¨æˆ·
- âœ… ä¼˜åŒ– `navigateBackOrHome()`ï¼Œæ”¯æŒè¿”å›ç™»å½•å‰é¡µé¢

### 3. å¾…å®ç°çš„é¡µé¢æ‹¦æˆª
ä»¥ä¸‹é¡µé¢éœ€è¦åœ¨å¼€å‘æ—¶æ·»åŠ ç™»å½•æ£€æŸ¥ï¼š

- [ ] `src/pages/checkout/index.tsx` - ç»“ç®—é¡µ
- [ ] `src/pages/payment/index.tsx` - æ”¯ä»˜é¡µ
- [ ] `src/pages/orders/index.tsx` - è®¢å•åˆ—è¡¨
- [ ] `src/pages/order-detail/index.tsx` - è®¢å•è¯¦æƒ…
- [ ] `src/pages/profile/index.tsx` - ä¸ªäººä¸­å¿ƒ
- [ ] `src/pages/coupons/index.tsx` - ä¼˜æƒ åˆ¸åˆ—è¡¨

---

## ğŸ¯ æœ€ä½³å®è·µ

1. **é¡µé¢å…¥å£æ£€æŸ¥**ï¼šåœ¨ `useEffect` ä¸­è°ƒç”¨ `requireLogin()`
2. **æŒ‰é’®ç‚¹å‡»æ£€æŸ¥**ï¼šåœ¨è·³è½¬å‰è°ƒç”¨ `requireLogin(redirectUrl)`
3. **ä¿å­˜ç”¨æˆ·æ„å›¾**ï¼š`requireLogin()` ä¼šè‡ªåŠ¨ä¿å­˜å½“å‰é¡µé¢è·¯å¾„ï¼Œç™»å½•æˆåŠŸåè¿”å›
4. **é¿å…é‡å¤æ‹¦æˆª**ï¼šä¸€ä¸ªæ“ä½œåªéœ€åœ¨ä¸€ä¸ªåœ°æ–¹æ£€æŸ¥ç™»å½•å³å¯

---

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **å…¬å…±é¡µé¢æ— éœ€æ£€æŸ¥**ï¼šèœå•é¡µã€å•†å“è¯¦æƒ…ç­‰æµè§ˆé¡µé¢æ— éœ€è°ƒç”¨ `requireLogin()`
2. **æ•æ„Ÿæ“ä½œåŒé‡æ£€æŸ¥**ï¼šæ”¯ä»˜ç­‰å…³é”®æ“ä½œå»ºè®®åœ¨å‰ç«¯å’Œåç«¯éƒ½æ£€æŸ¥ç™»å½•çŠ¶æ€
3. **ç”¨æˆ·ä½“éªŒä¼˜å…ˆ**ï¼šå°½é‡è®©ç”¨æˆ·åœ¨éœ€è¦æ—¶æ‰ç™»å½•ï¼Œé¿å…è¿‡æ—©æ‰“æ–­æµè§ˆ

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `docs/01-prd.md` - äº§å“éœ€æ±‚æ–‡æ¡£ï¼ˆé”™è¯¯ç  `NEED_LOGIN` è¯´æ˜ï¼‰
- `src/services/auth.ts` - è®¤è¯æœåŠ¡å®Œæ•´å®ç°
- `src/store/userStore.ts` - ç”¨æˆ·çŠ¶æ€ç®¡ç†
