<!-- pages/menu/menu.wxml -->
<view class="menu-page">
  <!-- 打烊提示 -->
  <van-notice-bar 
    wx:if="{{!shopIsOpen}}"
    left-icon="warning-o"
    text="店铺休息中，暂不接单"
    color="#ed6a0c"
    background="#fffbe8"
    bindtap="onShowShopDetail"
  />

  <!-- 加载状态 -->
  <view wx:if="{{loading}}" class="menu-page__loading">
    <van-loading type="spinner" size="48rpx">加载中...</van-loading>
  </view>

  <!-- 菜单内容 -->
  <view wx:else class="menu-page__container">
    <view class="header" style="padding-top: {{headerPaddingTop}}px;">
      <view class="header__toolbar" style="height: {{headerToolbarHeight}}px;">
        <view class="header__toolbar-left">
          <view class="header__icon-btn" hover-class="header__icon-btn--hover" bindtap="onGoHome">
            <t-icon name="home" size="20px" />
          </view>
          <view class="header__divider"></view>
          <view class="header__icon-btn" hover-class="header__icon-btn--hover" bindtap="onSearch">
            <t-icon name="search" size="20px" />
          </view>
        </view>
        <view class="header__toolbar-center">
          <text class="header__title">{{shopName || '清风茶記'}}</text>
        </view>
        <view class="header__toolbar-right"></view>
      </view>
      <view class="header__shop-info">
        <view class="header__shop-left">
          <view class="header__shop-name">
            <t-icon name="star" size="18px" color="#0052D9" />
            <text class="header__shop-name-text">{{shopName || '清风茶記'}}</text>
          </view>
          <view class="header__shop-distance">
            <t-icon name="location" size="16px" color="#999999" />
            <text class="header__shop-distance-text">配送范围 {{deliveryRadius}}</text>
          </view>
          <view class="header__shop-notice" bindtap="onShowShopDetail">
            <t-icon name="sound" size="16px" color="#999999" />
            <text class="header__shop-notice-text">{{shopAnnouncement || '商家暂无公告'}}</text>
          </view>
        </view>
        <view class="header__shop-right">
          <view 
            wx:if="{{supportsPickup || supportsDelivery}}"
            class="header__delivery-switch"
          >
            <view
              wx:if="{{supportsPickup}}"
              class="header__delivery-option {{deliveryMode === 'pickup' ? 'active' : ''}}"
              data-mode="pickup"
              bindtap="switchDeliveryMode"
            >
              到店
            </view>
            <view
              wx:if="{{supportsDelivery}}"
              class="header__delivery-option {{deliveryMode === 'delivery' ? 'active' : ''}}"
              data-mode="delivery"
              bindtap="switchDeliveryMode"
            >
              外卖
            </view>
          </view>
          <view 
            wx:else 
            class="header__delivery-status"
          >
            暂无配送/自取
          </view>
          <view class="header__more-info" bindtap="onShowShopDetail">
            <text>更多</text>
            <t-icon name="chevron-down" size="16px" class="header__more-info-arrow" />
          </view>
        </view>
      </view>
    </view>

    <view class="menu-page__content">
      <!-- 左侧分类导航 -->
      <view class="menu-page__sidebar">
        <van-sidebar 
          active-key="{{activeCategory}}" 
          bind:change="onCategoryChange"
        >
          <van-sidebar-item 
            wx:for="{{categories}}" 
            wx:key="category_id"
            title="{{item.name}}"
            name="{{item.category_id}}"
          />
        </van-sidebar>
      </view>

      <!-- 右侧商品列表 -->
      <scroll-view 
        class="menu-page__products" 
        scroll-y
        enhanced
        show-scrollbar="{{false}}"
      >
        <view wx:if="{{currentProducts.length === 0}}" class="menu-page__empty">
          <van-empty description="该分类暂无商品" />
        </view>

        <view wx:else class="menu-page__products-list">
          <view 
            wx:for="{{currentProducts}}" 
            wx:key="product_id"
            class="menu-page__product-item"
          >
            <product-card
              product-id="{{item.product_id}}"
              name="{{item.name}}"
              description="{{item.description}}"
              price="{{item.base_price}}"
              image-url="{{item.image_url}}"
              sold-out="{{item.inventory_status === 'sold_out'}}"
              bind:tap="onProductTap"
              bind:add="onProductAdd"
            />
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <!-- 店铺信息弹窗 -->
  <t-popup
    visible="{{shopDetailVisible}}"
    placement="bottom"
    z-index="10000"
    bind:visible-change="onShopDetailChange"
  >
    <view class="shop-detail-popup">
      <view class="shop-detail__header">
        <text class="shop-detail__title">{{shopName || '清风茶記'}}</text>
        <view class="shop-detail__close" bindtap="closeShopDetail">
          <t-icon name="close" size="20px" color="#999" />
        </view>
      </view>
      <view wx:if="{{shopDetailLoading}}" class="shop-detail__skeleton">
        <t-skeleton theme="paragraph" row-col="{{[1, 1, { width: '60%' }]}}" loading="{{true}}" />
      </view>
      <view wx:else class="shop-detail__content">
        <view class="shop-detail__section">
          <view class="shop-detail__section-title">公告</view>
          <view class="shop-detail__section-text {{shopAnnouncement ? '' : 'empty'}}">
            {{shopAnnouncement || '暂无公告'}}
          </view>
        </view>
        <view class="shop-detail__section">
          <view class="shop-detail__section-title">配送信息</view>
          <view class="shop-detail__section-text">
            <view 
              wx:for="{{deliveryInfoLines}}"
              wx:key="index"
              class="shop-detail__paragraph {{item.highlight ? 'highlight' : ''}}"
            >
              <text wx:if="{{item.highlight}}">✅ </text>{{item.text}}
            </view>
          </view>
        </view>
        <view class="shop-detail__section">
          <view class="shop-detail__section-title">门店信息</view>
          <view class="shop-detail__info-list">
            <view class="shop-detail__info-item">
              <view class="shop-detail__info-label">营业时间：</view>
              <view class="shop-detail__info-value {{shopIsOpen ? 'open' : 'closed'}}">{{businessHoursText}}</view>
            </view>
            <view class="shop-detail__info-item">
              <view class="shop-detail__info-label">联系电话：</view>
              <view class="shop-detail__info-value">{{shopPhone || '暂无信息'}}</view>
            </view>
            <view class="shop-detail__info-item">
              <view class="shop-detail__info-label">门店地址：</view>
              <view class="shop-detail__info-value">{{shopAddress || '暂无信息'}}</view>
            </view>
          </view>
        </view>
        <view class="shop-detail__actions">
          <view class="shop-detail__btn shop-detail__btn--primary" bindtap="onNavigateToShop">到店</view>
          <view class="shop-detail__btn shop-detail__btn--secondary" bindtap="onCallShop" aria-label="拨打电话">
            <t-icon name="call" size="24px" color="#666" />
          </view>
        </view>
      </view>
    </view>
  </t-popup>

  <!-- 规格选择弹窗 -->
  <t-popup
    visible="{{specPopupVisible}}"
    placement="bottom"
    z-index="11000"
    bind:visible-change="onSpecPopupChange"
  >
    <view class="spec-popup">
      <!-- 弹窗头部 -->
      <view class="spec-popup__header">
        <view class="spec-popup__product-info">
          <image 
            wx:if="{{selectedProduct.image_url}}"
            class="spec-popup__product-image" 
            src="{{selectedProduct.image_url}}"
            mode="aspectFill"
          />
          <view class="spec-popup__product-details">
            <view class="spec-popup__product-name">{{selectedProduct.name}}</view>
            <view class="spec-popup__product-price">¥{{specDisplayPrice}}</view>
          </view>
        </view>
        <view class="spec-popup__close" bindtap="closeSpecPopup">
          <t-icon name="close" size="20px" color="#999" />
        </view>
      </view>

      <!-- 规格选择 -->
      <scroll-view class="spec-popup__content" scroll-y enhanced show-scrollbar="{{false}}">
        <view wx:if="{{selectedProduct.spec_groups && selectedProduct.spec_groups.length > 0}}" class="spec-popup__specs">
          <view wx:for="{{selectedProduct.spec_groups}}" wx:key="group_id" class="spec-group">
            <view class="spec-group__header">
              <text class="spec-group__name">{{item.name}}</text>
              <text class="spec-group__required">必选</text>
            </view>
            <view class="spec-group__options">
              <view
                wx:for="{{item.options}}"
                wx:for-item="option"
                wx:key="option_id"
                class="spec-option {{specSelectedSpecs[item.group_id] && specSelectedSpecs[item.group_id].option_id === option.option_id ? 'spec-option--selected' : ''}} {{option.inventory_status === 'sold_out' ? 'spec-option--disabled' : ''}}"
                data-group-id="{{item.group_id}}"
                data-option="{{option}}"
                bindtap="handleSelectSpec"
              >
                <text class="spec-option__name">{{option.name}}</text>
                <text wx:if="{{option.price_modifier > 0}}" class="spec-option__price">+¥{{option.price_modifier}}</text>
                <text wx:if="{{option.inventory_status === 'sold_out'}}" class="spec-option__sold-out">售罄</text>
              </view>
            </view>
          </view>
        </view>

        <!-- 数量选择 -->
        <view class="spec-popup__quantity">
          <text class="spec-popup__quantity-label">数量</text>
          <t-stepper
            value="{{specQuantity}}"
            min="1"
            max="99"
            bind:change="handleSpecQuantityChange"
          />
        </view>
      </scroll-view>

      <!-- 底部操作栏 -->
      <view class="spec-popup__footer">
        <view class="spec-popup__total">
          <text class="spec-popup__total-label">小计</text>
          <text class="spec-popup__total-price">¥{{specTotalPrice}}</text>
        </view>
        <t-button
          theme="primary"
          size="large"
          shape="round"
          block
          bindtap="handleAddToCart"
        >
          加入购物车
        </t-button>
      </view>
    </view>
  </t-popup>
</view>
