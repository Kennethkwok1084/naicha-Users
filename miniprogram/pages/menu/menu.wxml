<view class="menu-page">
  <t-notice-bar
    wx:if="{{!shopIsOpen}}"
    prefixIcon="error-circle"
    content="店铺休息中，暂不接单"
    theme="warning"
    bindtap="onShowShopDetail"
  />

  <view wx:if="{{loading}}" class="menu-page__skeleton">
    <view class="menu-page__skeleton-left">
      <t-skeleton
        loading="{{true}}"
        animation="flashed"
        row-col="{{sidebarSkeleton}}"
      />
    </view>
    <view class="menu-page__skeleton-right">
      <t-skeleton
        loading="{{true}}"
        animation="flashed"
        row-col="{{productSkeleton}}"
      />
      <t-skeleton
        loading="{{true}}"
        animation="flashed"
        row-col="{{productSkeleton}}"
      />
    </view>
  </view>

  <view wx:else class="menu-page__container">
    <!-- 导航栏占位容器 -->
    <view style="height: {{navPlaceholderHeight}}px;"></view>
    
    <!-- 固定导航栏 -->
    <view class="header-bar" style="padding-top: {{statusBarHeight}}px;">
      <view class="header-bar__content" style="height: {{navBarHeight}}px;">
        <view class="header-bar__left">
          <view class="header-bar__icon-btn" bindtap="onGoBack">
            <t-icon name="chevron-left" size="40rpx" />
          </view>
          <view class="header-bar__icon-btn" bindtap="onGoHome">
            <t-icon name="home" size="40rpx" />
          </view>
        </view>
        <view class="header-bar__search" style="margin-right: {{menuButtonRight + 16}}px;">
          <t-search
            placeholder="搜饮品/口味/配料"
            value="{{searchKeyword}}"
            shape="round"
            clearable
            bind:change="handleSearchChange"
            bind:focus="handleSearchFocus"
            bind:clear="handleSearchClear"
            bind:submit="handleSearchConfirm"
          />
        </view>
      </view>
    </view>

    <view class="store-info">
      <view class="store-info__header">
        <view class="store-info__main">
          <t-icon name="location" size="28rpx" color="#333" />
          <text class="store-info__name">{{shopName || '星汇城店'}}</text>
        </view>
        <view class="store-info__actions">
          <view wx:if="{{supportsPickup || supportsDelivery}}" class="delivery-toggle">
            <view
              wx:if="{{supportsPickup}}"
              class="delivery-toggle__btn {{deliveryMode === 'pickup' ? 'delivery-toggle__btn--active' : ''}}"
              data-mode="pickup"
              bindtap="switchDeliveryMode"
            >
              自提
            </view>
            <view
              wx:if="{{supportsDelivery}}"
              class="delivery-toggle__btn {{deliveryMode === 'delivery' ? 'delivery-toggle__btn--active' : ''}}"
              data-mode="delivery"
              bindtap="switchDeliveryMode"
            >
              外送
            </view>
          </view>
        </view>
      </view>
      <text class="store-info__address">{{shopAddress || '杭州西湖区文一西路289号'}}</text>
      
      <view class="delivery-info" wx:if="{{deliveryInfoExpanded}}">
        <view class="delivery-info__item">
          <text class="delivery-info__label">配送范围：</text>
          <text class="delivery-info__value">门圧3公里范围内</text>
        </view>
        <view class="delivery-info__item">
          <text class="delivery-info__label">配送时间：</text>
          <text class="delivery-info__value">09:00-22:00</text>
        </view>
        <view class="delivery-info__item">
          <text class="delivery-info__label">配送费用：</text>
          <text class="delivery-info__value">基础运费￥3，满￥25包邮</text>
        </view>
        <view class="delivery-info__item">
          <text class="delivery-info__label">营业时间：</text>
          <text class="delivery-info__value">07:30-22:30</text>
        </view>
        <view class="delivery-info__actions">
          <view class="delivery-info__action-btn" bindtap="onCallShop">
            <t-icon name="call" size="32rpx" color="#7D4500" />
            <text>联系商家</text>
          </view>
          <view class="delivery-info__action-btn" bindtap="onNavigateToShop">
            <t-icon name="location" size="32rpx" color="#7D4500" />
            <text>到店导航</text>
          </view>
        </view>
      </view>
      
      <view class="delivery-info__toggle" bindtap="toggleDeliveryInfo">
        <text class="delivery-info__toggle-text">{{deliveryInfoExpanded ? '收起' : '展开'}}</text>
        <t-icon name="{{deliveryInfoExpanded ? 'chevron-up' : 'chevron-down'}}" size="24rpx" color="#7D4500" />
      </view>
    </view>

    <view class="menu-page__content">
      <view class="menu-page__sidebar">
        <t-side-bar
          value="{{activeCategory}}"
          bind:change="onCategoryChange"
        >
          <t-side-bar-item
            wx:for="{{categories}}"
            wx:key="category_id"
            label="{{item.name}}"
            value="{{item.category_id}}"
          />
        </t-side-bar>
      </view>

      <scroll-view
        class="menu-page__products"
        scroll-y
        enhanced
        show-scrollbar="{{false}}"
      >
        <view wx:if="{{currentProducts.length === 0}}" class="menu-page__empty">
          <t-empty description="该分类暂无商品" />
        </view>

        <view wx:else class="menu-page__products-list">
          <view
            wx:for="{{currentProducts}}"
            wx:key="product_id"
            class="menu-page__product-item"
          >
            <product-card
              product-id="{{item.product_id}}"
              name="{{item.name}}"
              description="{{item.description}}"
              price="{{item.base_price}}"
              image-url="{{item.image_url}}"
              sold-out="{{item.inventory_status === 'sold_out'}}"
              bind:tap="onProductTap"
              bind:add="onProductAdd"
            />
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <view class="cart-bar" wx:if="{{cartHasItems}}" style="bottom: {{cartBarBottom}}px;">
    <view class="cart-bar__left" bindtap="handleCartPreview">
      <view class="cart-bar__icon">
        <t-icon name="cart" size="44rpx" color="#7D4500" />
        <t-badge wx:if="{{cartBadgeCount > 0}}" count="{{cartBadgeCount}}" max-count="99" />
      </view>
      <view class="cart-bar__info">
        <text class="cart-bar__total">合计 ¥{{cartTotalPriceDisplay}}</text>
        <text class="cart-bar__hint">预计到手价 ¥{{cartFinalPriceDisplay}}</text>
      </view>
    </view>
    <view class="cart-bar__btn" bindtap="goCheckout">
      <text>去结算</text>
    </view>
  </view>
  <view class="cart-bar" wx:else style="bottom: {{cartBarBottom}}px;">
    <view class="cart-bar__left">
      <view class="cart-bar__icon">
        <t-icon name="cart" size="44rpx" color="#999" />
      </view>
      <text class="cart-bar__empty-hint">还没选商品～</text>
    </view>
    <view class="cart-bar__btn cart-bar__btn--disabled">
      <text>去结算</text>
    </view>
  </view>

  <t-popup
    visible="{{shopDetailVisible}}"
    placement="bottom"
    z-index="11000"
    bind:visible-change="onShopDetailChange"
  >
    <view class="shop-detail-popup">
      <view class="shop-detail__header">
        <text class="shop-detail__title">{{shopName || '清风茶記'}}</text>
        <view class="shop-detail__close" bindtap="closeShopDetail">
          <t-icon name="close" size="40rpx" color="#999" />
        </view>
      </view>
      <view wx:if="{{shopDetailLoading}}" class="shop-detail__skeleton">
        <t-skeleton theme="paragraph" row-col="{{[1, 1, { width: '60%' }]}}" loading="{{true}}" />
      </view>
      <view wx:else class="shop-detail__content">
        <view class="shop-detail__section">
          <view class="shop-detail__section-title">公告</view>
          <view class="shop-detail__section-text {{shopAnnouncement ? '' : 'empty'}}">
            {{shopAnnouncement || '暂无公告'}}
          </view>
        </view>
        <view class="shop-detail__section">
          <view class="shop-detail__section-title">配送信息</view>
          <view class="shop-detail__section-text">
            <view
              wx:for="{{deliveryInfoLines}}"
              wx:key="index"
              class="shop-detail__paragraph {{item.highlight ? 'highlight' : ''}}"
            >
              <text wx:if="{{item.highlight}}">✅ </text>{{item.text}}
            </view>
          </view>
        </view>
        <view class="shop-detail__section">
          <view class="shop-detail__section-title">门店信息</view>
          <view class="shop-detail__info-list">
            <view class="shop-detail__info-item">
              <view class="shop-detail__info-label">营业时间：</view>
              <view class="shop-detail__info-value {{shopIsOpen ? 'open' : 'closed'}}">{{businessHoursText}}</view>
            </view>
            <view class="shop-detail__info-item">
              <view class="shop-detail__info-label">联系电话：</view>
              <view class="shop-detail__info-value">{{shopPhone || '暂无信息'}}</view>
            </view>
            <view class="shop-detail__info-item">
              <view class="shop-detail__info-label">门店地址：</view>
              <view class="shop-detail__info-value">{{shopAddress || '暂无信息'}}</view>
            </view>
          </view>
        </view>
        <view class="shop-detail__actions">
          <view class="shop-detail__btn shop-detail__btn--primary" bindtap="onNavigateToShop">到店导航</view>
          <view class="shop-detail__btn shop-detail__btn--secondary" bindtap="onCallShop" aria-label="拨打电话">
            <t-icon name="call" size="48rpx" color="#666" />
          </view>
        </view>
      </view>
    </view>
  </t-popup>

  <!-- 规格选择弹窗 -->
  <t-popup
    visible="{{specPopupVisible}}"
    placement="bottom"
    z-index="12000"
    custom-overlay-style="z-index:12000;"
    close-on-overlay-click="{{false}}"
    bind:visible-change="onSpecPopupChange"
  >
    <view
      class="popup-container"
      style="height: {{specPopupHeight}}px; max-height: {{specPopupMaxHeight}}px;"
      bind:touchstart="onPopupTouchStart"
      bind:touchmove="onPopupTouchMove"
      bind:touchend="onPopupTouchEnd"
    >
      <!-- 关闭按钮 -->
      <view class="close-btn" bindtap="closeSpecPopup">
        <t-icon name="close" size="32rpx" color="#FFF" />
      </view>

      <!-- 滚动区域 - 包含图片、产品信息、规格和数量 -->
      <scroll-view 
        class="scroll-content" 
        scroll-y 
        enhanced 
        show-scrollbar="{{false}}"
      >
        <!-- 顶部产品宣传图 -->
        <view class="popup-banner">
          <image 
            class="banner-image" 
            src="{{selectedProduct.image_url}}" 
            mode="aspectFill"
          />
        </view>

        <!-- 产品信息卡片 -->
        <view class="popup-info-card">
          <view class="product-title">{{selectedProduct.name}}</view>
          <view class="product-subtitle" wx:if="{{selectedProduct.description}}">
            {{selectedProduct.description}}
          </view>
        </view>

        <!-- 规格选择区域 -->
        <block wx:for="{{specGroups}}" wx:key="group_id" wx:for-item="group">
          <view class="topping-section">
            <view class="section-title">
              <text>{{group.name}}</text>
              <text wx:if="{{group.required}}" class="required-tag">必选</text>
            </view>
            
            <view class="option-container">
              <block wx:for="{{group.options}}" wx:for-item="opt" wx:key="option_id">
                <view
                  class="spec-option {{opt._selected ? 'active' : ''}} {{opt.inventory_status === 'sold_out' ? 'disabled' : ''}}"
                  data-group-id="{{group.group_id}}"
                  data-option-id="{{opt.option_id}}"
                  bindtap="onSpecOptionTap"
                >
                  <text class="option-name">{{opt.name}}</text>
                  <text 
                    wx:if="{{opt.price_modifier > 0}}"
                    class="price-tag"
                  >
                    +¥{{opt.price_modifier}}
                  </text>
                  <view 
                    wx:if="{{opt.inventory_status === 'sold_out'}}"
                    class="option-tag"
                  >
                    <text>售罄</text>
                  </view>
                </view>
              </block>
            </view>
          </view>
        </block>

        <!-- 数量选择 -->
        <view class="quantity-container">
          <view class="quantity-text">
            <text>数量</text>
          </view>
          <view class="stepper">
            <view 
              class="minus-btn {{specQuantity <= 1 ? 'disabled' : ''}}"
              bindtap="handleQuantityMinus"
            >
              <t-icon name="remove" size="32rpx" color="#333" />
            </view>
            <view class="quantity">
              <text>{{specQuantity}}</text>
            </view>
            <view class="plus-btn" bindtap="handleQuantityPlus">
              <t-icon name="add" size="32rpx" color="#333" />
            </view>
          </view>
        </view>
      </scroll-view>

      <!-- 底部操作栏 - 放在最后 -->
      <view class="action-bar" style="padding-bottom: {{actionBarPaddingBottom}}px;">
        <view class="action-price">
          <text class="action-price__label">小计: </text>
          <text class="action-price__value">¥{{specTotalPrice}}</text>
        </view>
        <view class="action-buttons">
          <view class="action-btn cart-btn" bindtap="handleAddToCart">
            <text>加入购物车</text>
          </view>
          <view class="action-btn buy-btn" bindtap="handleBuyNow">
            <text>立即购买</text>
          </view>
        </view>
      </view>
    </view>
  </t-popup>
</view>
