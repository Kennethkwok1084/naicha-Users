<view class="menu-page">
  <t-notice-bar
    wx:if="{{!shopIsOpen}}"
    prefixIcon="error-circle"
    content="店铺休息中，暂不接单"
    theme="warning"
    bindtap="onShowShopDetail"
  />

  <view wx:if="{{loading}}" class="menu-page__skeleton">
    <view class="menu-page__skeleton-left">
      <t-skeleton
        loading="{{true}}"
        animation="flashed"
        row-col="{{sidebarSkeleton}}"
      />
    </view>
    <view class="menu-page__skeleton-right">
      <t-skeleton
        loading="{{true}}"
        animation="flashed"
        row-col="{{productSkeleton}}"
      />
      <t-skeleton
        loading="{{true}}"
        animation="flashed"
        row-col="{{productSkeleton}}"
      />
    </view>
  </view>

  <view wx:else class="menu-page__container">
    <!-- 导航栏占位容器 -->
    <view style="height: {{navPlaceholderHeight}}px;"></view>
    
    <!-- 固定导航栏 -->
    <view class="header-bar" style="height: {{navBarHeight}}px; padding-top: {{statusBarHeight}}px;">
      <view class="header-bar__content">
        <view class="header-bar__left">
          <view class="header-bar__icon-btn" bindtap="onGoBack">
            <t-icon name="chevron-left" size="40rpx" />
          </view>
          <view class="header-bar__icon-btn" bindtap="onGoHome">
            <t-icon name="home" size="40rpx" />
          </view>
        </view>
        <view class="header-bar__search">
          <t-search
            placeholder="搜饮品/口味/配料"
            value="{{searchKeyword}}"
            shape="round"
            clearable
            bind:change="handleSearchChange"
            bind:focus="handleSearchFocus"
            bind:clear="handleSearchClear"
            bind:submit="handleSearchConfirm"
          />
        </view>
        <view class="header-bar__right">
          <view class="header-bar__more-btn" bindtap="onShowShopDetail">
            <t-icon name="ellipsis" size="40rpx" />
          </view>
        </view>
      </view>
    </view>

    <view class="store-info">
      <view class="store-info__header" bindtap="onShowShopDetail">
        <view class="store-info__main">
          <t-icon name="location" size="28rpx" color="#333" />
          <text class="store-info__name">{{shopName || '星汇城店'}}</text>
        </view>
        <view class="store-info__actions">
          <view wx:if="{{supportsPickup || supportsDelivery}}" class="delivery-toggle">
            <view
              wx:if="{{supportsPickup}}"
              class="delivery-toggle__btn {{deliveryMode === 'pickup' ? 'delivery-toggle__btn--active' : ''}}"
              data-mode="pickup"
              bindtap="switchDeliveryMode"
            >
              自提
            </view>
            <view
              wx:if="{{supportsDelivery}}"
              class="delivery-toggle__btn {{deliveryMode === 'delivery' ? 'delivery-toggle__btn--active' : ''}}"
              data-mode="delivery"
              bindtap="switchDeliveryMode"
            >
              外送
            </view>
          </view>
        </view>
      </view>
      <text class="store-info__address">{{shopAddress || '杭州西湖区文一西路289号'}}</text>
      
      <view class="delivery-info" wx:if="{{deliveryInfoExpanded}}">
        <view class="delivery-info__item">
          <text class="delivery-info__label">配送范围：</text>
          <text class="delivery-info__value">门店3公里范围内</text>
        </view>
        <view class="delivery-info__item">
          <text class="delivery-info__label">配送时间：</text>
          <text class="delivery-info__value">09:00-22:00</text>
        </view>
        <view class="delivery-info__item">
          <text class="delivery-info__label">配送费用：</text>
          <text class="delivery-info__value">基础运费¥3，满¥25包邮</text>
        </view>
        <view class="delivery-info__item">
          <text class="delivery-info__label">营业时间：</text>
          <text class="delivery-info__value">07:30-22:30</text>
        </view>
      </view>
      
      <view class="delivery-info__toggle" bindtap="toggleDeliveryInfo">
        <text class="delivery-info__toggle-text">{{deliveryInfoExpanded ? '收起' : '展开'}}</text>
        <t-icon name="{{deliveryInfoExpanded ? 'chevron-up' : 'chevron-down'}}" size="24rpx" color="#7D4500" />
      </view>
    </view>

    <view class="menu-page__content">
      <view class="menu-page__sidebar">
        <t-side-bar
          value="{{activeCategory}}"
          bind:change="onCategoryChange"
        >
          <t-side-bar-item
            wx:for="{{categories}}"
            wx:key="category_id"
            label="{{item.name}}"
            value="{{item.category_id}}"
          />
        </t-side-bar>
      </view>

      <scroll-view
        class="menu-page__products"
        scroll-y
        enhanced
        show-scrollbar="{{false}}"
      >
        <view wx:if="{{currentProducts.length === 0}}" class="menu-page__empty">
          <t-empty description="该分类暂无商品" />
        </view>

        <view wx:else class="menu-page__products-list">
          <view
            wx:for="{{currentProducts}}"
            wx:key="product_id"
            class="menu-page__product-item"
          >
            <product-card
              product-id="{{item.product_id}}"
              name="{{item.name}}"
              description="{{item.description}}"
              price="{{item.base_price}}"
              image-url="{{item.image_url}}"
              sold-out="{{item.inventory_status === 'sold_out'}}"
              bind:tap="onProductTap"
              bind:add="onProductAdd"
            />
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <view class="cart-bar" wx:if="{{cartHasItems}}">
    <view class="cart-bar__left" bindtap="handleCartPreview">
      <view class="cart-bar__icon">
        <t-icon name="cart" size="44rpx" color="#7D4500" />
        <t-badge wx:if="{{cartBadgeCount > 0}}" count="{{cartBadgeCount}}" max-count="99" />
      </view>
      <view class="cart-bar__info">
        <text class="cart-bar__total">合计 ¥{{cartTotalPriceDisplay}}</text>
        <text class="cart-bar__hint">预计到手价 ¥{{cartFinalPriceDisplay}}</text>
      </view>
    </view>
    <view class="cart-bar__btn" bindtap="goCheckout">
      <text>去结算</text>
    </view>
  </view>
  <view class="cart-bar" wx:else>
    <view class="cart-bar__left">
      <view class="cart-bar__icon">
        <t-icon name="cart" size="44rpx" color="#999" />
      </view>
      <text class="cart-bar__empty-hint">还没选商品～</text>
    </view>
    <view class="cart-bar__btn cart-bar__btn--disabled">
      <text>去结算</text>
    </view>
  </view>

  <t-popup
    visible="{{shopDetailVisible}}"
    placement="bottom"
    z-index="10000"
    bind:visible-change="onShopDetailChange"
  >
    <view class="shop-detail-popup">
      <view class="shop-detail__header">
        <text class="shop-detail__title">{{shopName || '清风茶記'}}</text>
        <view class="shop-detail__close" bindtap="closeShopDetail">
          <t-icon name="close" size="40rpx" color="#999" />
        </view>
      </view>
      <view wx:if="{{shopDetailLoading}}" class="shop-detail__skeleton">
        <t-skeleton theme="paragraph" row-col="{{[1, 1, { width: '60%' }]}}" loading="{{true}}" />
      </view>
      <view wx:else class="shop-detail__content">
        <view class="shop-detail__section">
          <view class="shop-detail__section-title">公告</view>
          <view class="shop-detail__section-text {{shopAnnouncement ? '' : 'empty'}}">
            {{shopAnnouncement || '暂无公告'}}
          </view>
        </view>
        <view class="shop-detail__section">
          <view class="shop-detail__section-title">配送信息</view>
          <view class="shop-detail__section-text">
            <view
              wx:for="{{deliveryInfoLines}}"
              wx:key="index"
              class="shop-detail__paragraph {{item.highlight ? 'highlight' : ''}}"
            >
              <text wx:if="{{item.highlight}}">✅ </text>{{item.text}}
            </view>
          </view>
        </view>
        <view class="shop-detail__section">
          <view class="shop-detail__section-title">门店信息</view>
          <view class="shop-detail__info-list">
            <view class="shop-detail__info-item">
              <view class="shop-detail__info-label">营业时间：</view>
              <view class="shop-detail__info-value {{shopIsOpen ? 'open' : 'closed'}}">{{businessHoursText}}</view>
            </view>
            <view class="shop-detail__info-item">
              <view class="shop-detail__info-label">联系电话：</view>
              <view class="shop-detail__info-value">{{shopPhone || '暂无信息'}}</view>
            </view>
            <view class="shop-detail__info-item">
              <view class="shop-detail__info-label">门店地址：</view>
              <view class="shop-detail__info-value">{{shopAddress || '暂无信息'}}</view>
            </view>
          </view>
        </view>
        <view class="shop-detail__actions">
          <view class="shop-detail__btn shop-detail__btn--primary" bindtap="onNavigateToShop">到店导航</view>
          <view class="shop-detail__btn shop-detail__btn--secondary" bindtap="onCallShop" aria-label="拨打电话">
            <t-icon name="call" size="48rpx" color="#666" />
          </view>
        </view>
      </view>
    </view>
  </t-popup>

  <!-- 规格选择弹窗 -->
  <t-popup
    visible="{{specPopupVisible}}"
    placement="bottom"
    z-index="11000"
    close-on-overlay-click="{{false}}"
    bind:visible-change="onSpecPopupChange"
  >
    <view class="spec-popup">
      <!-- 骨架屏加载状态 -->
      <view wx:if="{{specPopupLoading}}" class="spec-popup__skeleton">
        <view class="spec-popup__skeleton-header">
          <view class="spec-popup__skeleton-image"></view>
          <view class="spec-popup__close" bindtap="closeSpecPopup">
            <t-icon name="close" size="48rpx" color="#fff" />
          </view>
        </view>
        <view class="spec-popup__skeleton-info">
          <t-skeleton theme="paragraph" row-col="{{[[{width: '30%', height: '40rpx'}], [{width: '60%', height: '28rpx'}], [{width: '80%', height: '24rpx'}]]}}" loading="{{true}}" />
        </view>
        <view class="spec-popup__skeleton-content">
          <view class="spec-group" wx:for="{{[1,2,3]}}" wx:key="*this">
            <t-skeleton theme="paragraph" row-col="{{[[{width: '25%', height: '28rpx'}], {width: '100%', height: '60rpx'}, {width: '100%', height: '60rpx'}]}}" loading="{{true}}" />
          </view>
        </view>
      </view>

      <!-- 实际内容 -->
      <block wx:else>
        <!-- 商品图片与关闭按钮 -->
        <view class="spec-popup__header">
          <image
            class="spec-popup__image"
            src="{{selectedProduct.image_url || productImagePlaceholder}}"
            mode="aspectFill"
          />
          <view class="spec-popup__close" bindtap="closeSpecPopup">
            <t-icon name="close" size="48rpx" color="#fff" />
          </view>
        </view>

        <!-- 商品信息 -->
        <view class="spec-popup__info">
          <view class="spec-popup__price-row">
            <text class="spec-popup__price">¥{{specDisplayPrice}}</text>
            <text class="spec-popup__stock">库存充足</text>
          </view>
          <text class="spec-popup__name">{{selectedProduct.name}}</text>
          <text class="spec-popup__desc">{{selectedProduct.description}}</text>
        </view>

        <!-- 规格选择区域 -->
        <scroll-view class="spec-popup__content" scroll-y enhanced show-scrollbar="{{false}}">
          <!-- 规格组 -->
        <block wx:for="{{specGroups}}" wx:key="group_id" wx:for-item="group">
          <view class="spec-group">
            <view class="spec-group__title">
              <text>{{group.name}}</text>
              <t-tag
                wx:if="{{specGroupBehaviors[group.group_id] && specGroupBehaviors[group.group_id].tag}}"
                size="small"
                theme="primary"
                variant="light"
              >
                {{specGroupBehaviors[group.group_id].tag}}
              </t-tag>
            </view>

            <!-- 规格选项 - 胶囊按钮样式 -->
            <view class="spec-options-grid">
              <block wx:for="{{group.options}}" wx:for-item="opt" wx:key="option_id">
                <view
                  class="spec-tag {{opt._selected ? 'spec-tag--selected' : ''}} {{opt.inventory_status === 'sold_out' ? 'spec-tag--disabled' : ''}}"
                  data-group-id="{{group.group_id}}"
                  data-option-id="{{opt.option_id}}"
                  bindtap="onSpecOptionTap"
                >
                  <text class="spec-tag__name">{{opt.name}}</text>
                  <text 
                    wx:if="{{opt.price_modifier > 0}}"
                    class="spec-tag__price"
                  >
                    +¥{{opt.price_modifier}}
                  </text>
                  <text
                    wx:if="{{opt.inventory_status === 'sold_out'}}"
                    class="spec-tag__soldout"
                  >
                    售罄
                  </text>
                </view>
              </block>
            </view>
          </view>
        </block>

        <!-- 数量选择 -->
        <view class="spec-group">
          <view class="spec-option-item">
            <text class="spec-option-name">数量</text>
            <t-stepper
              value="{{specQuantity}}"
              min="1"
              max="99"
              theme="filled"
              bind:change="handleSpecQuantityChange"
            />
          </view>
        </view>

        <!-- 备注 -->
        <view class="spec-group">
          <view class="spec-group__title">
            <text>口味备注</text>
          </view>
          <t-textarea
            placeholder="少冰/走糖等需求"
            maxlength="50"
            value="{{specNote}}"
            bind:change="handleSpecNoteChange"
            indicator
            autosize
          />
        </view>
      </scroll-view>

        <!-- 底部操作栏 -->
        <view class="spec-popup__footer">
          <view class="spec-popup__total">
            <text class="spec-popup__total-label">小计</text>
            <text class="spec-popup__total-price">¥{{specTotalPrice}}</text>
          </view>
          <view class="spec-popup__actions">
            <t-button
              class="spec-popup__btn spec-popup__btn--secondary"
              theme="light"
              size="large"
              block
              bind:tap="handleAddToCart"
            >
              加入购物车
            </t-button>
            <t-button
              class="spec-popup__btn spec-popup__btn--primary"
              theme="primary"
              size="large"
              block
              bind:tap="handleBuyNow"
            >
              立即购买
            </t-button>
          </view>
        </view>
      </block>
    </view>
  </t-popup>
</view>
