<view class="menu-page">
  <t-notice-bar
    wx:if="{{!shopIsOpen}}"
    prefixIcon="error-circle"
    content="店铺休息中，暂不接单"
    theme="warning"
    bindtap="onShowShopDetail"
  />

  <view wx:if="{{loading}}" class="menu-page__skeleton">
    <view class="menu-page__skeleton-left">
      <t-skeleton
        loading="{{true}}"
        animation="flashed"
        row-col="{{sidebarSkeleton}}"
      />
    </view>
    <view class="menu-page__skeleton-right">
      <t-skeleton
        loading="{{true}}"
        animation="flashed"
        row-col="{{productSkeleton}}"
      />
      <t-skeleton
        loading="{{true}}"
        animation="flashed"
        row-col="{{productSkeleton}}"
      />
    </view>
  </view>

  <view wx:else class="menu-page__container">
    <view class="app-bar" style="padding-top: {{headerPaddingTop}}px;">
      <view class="app-bar__inner" style="height: {{headerToolbarHeight}}px;">
        <view class="app-bar__left">
          <t-button
            variant="text"
            shape="round"
            size="small"
            class="app-bar__icon-btn"
            bindtap="onGoBack"
          >
            <t-icon name="chevron-left" size="20px" />
          </t-button>
          <t-button
            variant="text"
            shape="round"
            size="small"
            class="app-bar__icon-btn"
            bindtap="onGoHome"
          >
            <t-icon name="home" size="20px" />
          </t-button>
        </view>
        <view class="app-bar__center">
          <t-search
            placeholder="搜饮品/口味/配料"
            value="{{searchKeyword}}"
            shape="round"
            clearable
            actionText="搜索"
            bind:change="handleSearchChange"
            bind:focus="handleSearchFocus"
            bind:clear="handleSearchClear"
            bind:submit="handleSearchConfirm"
          />
        </view>
        <view class="app-bar__right">
          <view class="app-bar__wechat-placeholder"></view>
        </view>
      </view>
    </view>

    <view class="store-bar">
      <view class="store-bar__info" hover-class="store-bar__info--hover" bindtap="onShowShopDetail">
        <t-icon name="location" size="20px" />
        <view class="store-bar__text">
          <text class="store-bar__name">{{shopName || '清风茶記'}}</text>
          <text class="store-bar__address">{{shopAddress || '选择门店可查看地址'}}</text>
        </view>
      </view>
      <view class="store-bar__service">
        <view wx:if="{{supportsPickup || supportsDelivery}}" class="delivery-mode-switcher">
          <view
            wx:if="{{supportsPickup}}"
            class="delivery-mode-option {{deliveryMode === 'pickup' ? 'delivery-mode-option--active' : ''}}"
            data-mode="pickup"
            bindtap="switchDeliveryMode"
          >
            自提
          </view>
          <view
            wx:if="{{supportsDelivery}}"
            class="delivery-mode-option {{deliveryMode === 'delivery' ? 'delivery-mode-option--active' : ''}}"
            data-mode="delivery"
            bindtap="switchDeliveryMode"
          >
            外送
          </view>
        </view>
        <text wx:else class="store-bar__service-empty">暂不支持配送/自取</text>
      </view>
    </view>

    <view class="notice-section" bindtap="toggleNotice">
      <t-notice-bar
        class="notice-section__bar"
        prefixIcon="sound"
        suffixIcon="{{noticeExpanded ? 'chevron-up' : 'chevron-down'}}"
        content="{{shopAnnouncement || '商家暂无公告'}}"
        theme="info"
        marquee="{{currentNoticeMarquee}}"
      />
      <view wx:if="{{noticeExpanded}}" class="notice-section__detail">
        <text class="notice-section__detail-text">{{shopAnnouncement || '暂无公告'}}</text>
      </view>
    </view>

    <view class="store-extra" wx:if="{{deliveryInfoLines.length}}">
      <view
        wx:for="{{deliveryInfoLines}}"
        wx:key="index"
        class="store-extra__item {{item.highlight ? 'is-highlight' : ''}}"
      >
        {{item.text}}
      </view>
    </view>

    <view class="menu-page__content">
      <view class="menu-page__sidebar">
        <t-side-bar
          value="{{activeCategory}}"
          bind:change="onCategoryChange"
        >
          <t-side-bar-item
            wx:for="{{categories}}"
            wx:key="category_id"
            label="{{item.name}}"
            value="{{item.category_id}}"
          />
        </t-side-bar>
      </view>

      <scroll-view
        class="menu-page__products"
        scroll-y
        enhanced
        show-scrollbar="{{false}}"
      >
        <view wx:if="{{currentProducts.length === 0}}" class="menu-page__empty">
          <t-empty description="该分类暂无商品" />
        </view>

        <view wx:else class="menu-page__products-list">
          <view
            wx:for="{{currentProducts}}"
            wx:key="product_id"
            class="menu-page__product-item"
          >
            <product-card
              product-id="{{item.product_id}}"
              name="{{item.name}}"
              description="{{item.description}}"
              price="{{item.base_price}}"
              image-url="{{item.image_url}}"
              sold-out="{{item.inventory_status === 'sold_out'}}"
              bind:tap="onProductTap"
              bind:add="onProductAdd"
            />
          </view>
        </view>
      </scroll-view>
    </view>
  </view>

  <view class="cart-bar" wx:if="{{cartHasItems}}">
    <view class="cart-bar__left" bindtap="handleCartPreview">
      <view class="cart-bar__bag">
        <t-icon name="cart" size="24px" />
        <t-badge wx:if="{{cartBadgeCount > 0}}" count="{{cartBadgeCount}}" max-count="99" />
      </view>
      <view class="cart-bar__meta">
        <text class="cart-bar__total">合计 ¥{{cartTotalPriceDisplay}}</text>
        <text class="cart-bar__hint">{{cartDeliveryHint}}</text>
      </view>
    </view>
    <t-button
      class="cart-bar__btn"
      theme="primary"
      size="large"
      shape="round"
      bindtap="goCheckout"
    >
      去结算
    </t-button>
  </view>
  <view class="cart-bar cart-bar--empty" wx:else>
    <view class="cart-bar__left" bindtap="handleCartPreview">
      <view class="cart-bar__bag">
        <t-icon name="cart" size="24px" />
      </view>
      <text class="cart-bar__hint">还没选商品～</text>
    </view>
    <t-button
      class="cart-bar__btn"
      theme="primary"
      size="large"
      shape="round"
      disabled
    >
      去结算
    </t-button>
  </view>

  <t-popup
    visible="{{shopDetailVisible}}"
    placement="bottom"
    z-index="10000"
    bind:visible-change="onShopDetailChange"
  >
    <view class="shop-detail-popup">
      <view class="shop-detail__header">
        <text class="shop-detail__title">{{shopName || '清风茶記'}}</text>
        <view class="shop-detail__close" bindtap="closeShopDetail">
          <t-icon name="close" size="20px" color="#999" />
        </view>
      </view>
      <view wx:if="{{shopDetailLoading}}" class="shop-detail__skeleton">
        <t-skeleton theme="paragraph" row-col="{{[1, 1, { width: '60%' }]}}" loading="{{true}}" />
      </view>
      <view wx:else class="shop-detail__content">
        <view class="shop-detail__section">
          <view class="shop-detail__section-title">公告</view>
          <view class="shop-detail__section-text {{shopAnnouncement ? '' : 'empty'}}">
            {{shopAnnouncement || '暂无公告'}}
          </view>
        </view>
        <view class="shop-detail__section">
          <view class="shop-detail__section-title">配送信息</view>
          <view class="shop-detail__section-text">
            <view
              wx:for="{{deliveryInfoLines}}"
              wx:key="index"
              class="shop-detail__paragraph {{item.highlight ? 'highlight' : ''}}"
            >
              <text wx:if="{{item.highlight}}">✅ </text>{{item.text}}
            </view>
          </view>
        </view>
        <view class="shop-detail__section">
          <view class="shop-detail__section-title">门店信息</view>
          <view class="shop-detail__info-list">
            <view class="shop-detail__info-item">
              <view class="shop-detail__info-label">营业时间：</view>
              <view class="shop-detail__info-value {{shopIsOpen ? 'open' : 'closed'}}">{{businessHoursText}}</view>
            </view>
            <view class="shop-detail__info-item">
              <view class="shop-detail__info-label">联系电话：</view>
              <view class="shop-detail__info-value">{{shopPhone || '暂无信息'}}</view>
            </view>
            <view class="shop-detail__info-item">
              <view class="shop-detail__info-label">门店地址：</view>
              <view class="shop-detail__info-value">{{shopAddress || '暂无信息'}}</view>
            </view>
          </view>
        </view>
        <view class="shop-detail__actions">
          <view class="shop-detail__btn shop-detail__btn--primary" bindtap="onNavigateToShop">到店导航</view>
          <view class="shop-detail__btn shop-detail__btn--secondary" bindtap="onCallShop" aria-label="拨打电话">
            <t-icon name="call" size="24px" color="#666" />
          </view>
        </view>
      </view>
    </view>
  </t-popup>

  <!-- 规格选择弹窗 -->
  <t-popup
    visible="{{specPopupVisible}}"
    placement="bottom"
    z-index="11000"
    close-on-overlay-click="{{false}}"
    bind:visible-change="onSpecPopupChange"
  >
    <view class="spec-popup">
      <!-- 骨架屏加载状态 -->
      <view wx:if="{{specPopupLoading}}" class="spec-popup__skeleton">
        <view class="spec-popup__skeleton-header">
          <view class="spec-popup__skeleton-image"></view>
          <view class="spec-popup__close" bindtap="closeSpecPopup">
            <t-icon name="close" size="48rpx" color="#fff" />
          </view>
        </view>
        <view class="spec-popup__skeleton-info">
          <t-skeleton theme="paragraph" row-col="{{[[{width: '30%', height: '40rpx'}], [{width: '60%', height: '28rpx'}], [{width: '80%', height: '24rpx'}]]}}" loading="{{true}}" />
        </view>
        <view class="spec-popup__skeleton-content">
          <view class="spec-group" wx:for="{{[1,2,3]}}" wx:key="*this">
            <t-skeleton theme="paragraph" row-col="{{[[{width: '25%', height: '28rpx'}], {width: '100%', height: '60rpx'}, {width: '100%', height: '60rpx'}]}}" loading="{{true}}" />
          </view>
        </view>
      </view>

      <!-- 实际内容 -->
      <block wx:else>
        <!-- 商品图片与关闭按钮 -->
        <view class="spec-popup__header">
          <image
            class="spec-popup__image"
            src="{{selectedProduct.image_url || productImagePlaceholder}}"
            mode="aspectFill"
          />
          <view class="spec-popup__close" bindtap="closeSpecPopup">
            <t-icon name="close" size="48rpx" color="#fff" />
          </view>
        </view>

        <!-- 商品信息 -->
        <view class="spec-popup__info">
          <view class="spec-popup__price-row">
            <text class="spec-popup__price">¥{{specDisplayPrice}}</text>
            <text class="spec-popup__stock">库存充足</text>
          </view>
          <text class="spec-popup__name">{{selectedProduct.name}}</text>
          <text class="spec-popup__desc">{{selectedProduct.description}}</text>
        </view>

        <!-- 规格选择区域 -->
        <scroll-view class="spec-popup__content" scroll-y enhanced show-scrollbar="{{false}}">
          <!-- 规格组 -->
        <block wx:for="{{specGroups}}" wx:key="group_id" wx:for-item="group">
          <view class="spec-group">
            <view class="spec-group__title">
              <text>{{group.name}}</text>
              <t-tag
                wx:if="{{specGroupBehaviors[group.group_id] && specGroupBehaviors[group.group_id].tag}}"
                size="small"
                theme="primary"
                variant="light"
              >
                {{specGroupBehaviors[group.group_id].tag}}
              </t-tag>
            </view>

            <!-- 规格选项 - 胶囊按钮样式 -->
            <view class="spec-options-grid">
              <block wx:for="{{group.options}}" wx:for-item="opt" wx:key="option_id">
                <view
                  class="spec-tag {{opt._selected ? 'spec-tag--selected' : ''}} {{opt.inventory_status === 'sold_out' ? 'spec-tag--disabled' : ''}}"
                  data-group-id="{{group.group_id}}"
                  data-option-id="{{opt.option_id}}"
                  bindtap="onSpecOptionTap"
                >
                  <text class="spec-tag__name">{{opt.name}}</text>
                  <text 
                    wx:if="{{opt.price_modifier > 0}}"
                    class="spec-tag__price"
                  >
                    +¥{{opt.price_modifier}}
                  </text>
                  <text
                    wx:if="{{opt.inventory_status === 'sold_out'}}"
                    class="spec-tag__soldout"
                  >
                    售罄
                  </text>
                </view>
              </block>
            </view>
          </view>
        </block>

        <!-- 数量选择 -->
        <view class="spec-group">
          <view class="spec-option-item">
            <text class="spec-option-name">数量</text>
            <t-stepper
              value="{{specQuantity}}"
              min="1"
              max="99"
              theme="filled"
              bind:change="handleSpecQuantityChange"
            />
          </view>
        </view>

        <!-- 备注 -->
        <view class="spec-group">
          <view class="spec-group__title">
            <text>口味备注</text>
          </view>
          <t-textarea
            placeholder="少冰/走糖等需求"
            maxlength="50"
            value="{{specNote}}"
            bind:change="handleSpecNoteChange"
            indicator
            autosize
          />
        </view>
      </scroll-view>

        <!-- 底部操作栏 -->
        <view class="spec-popup__footer">
          <view class="spec-popup__total">
            <text class="spec-popup__total-label">小计</text>
            <text class="spec-popup__total-price">¥{{specTotalPrice}}</text>
          </view>
          <view class="spec-popup__actions">
            <t-button
              theme="light"
              size="large"
              bind:tap="handleAddToCart"
            >
              加入购物车
            </t-button>
            <t-button
              theme="primary"
              size="large"
              bind:tap="handleBuyNow"
            >
              立即购买
            </t-button>
          </view>
        </view>
      </block>
    </view>
  </t-popup>
</view>
