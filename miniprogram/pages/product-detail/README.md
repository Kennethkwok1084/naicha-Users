# 商品详情页

## 功能说明

商品详情页是用户查看商品信息、选择规格、加入购物车的核心页面。

## 页面路径

`pages/product-detail/product-detail`

## 路由参数

- `id`: 商品 ID (number)

## 主要功能

### 1. 商品信息展示
- 商品图片 (支持占位图)
- 商品名称
- 商品描述
- 基础价格
- 库存状态 (在售/售罄)

### 2. 规格选择器
- 支持多规格组 (如：糖度、温度、小料等)
- 实时显示规格价格加价
- 售罄规格置灰禁用
- 选中状态高亮显示
- 动态计算总价

### 3. 数量选择
- 使用 Vant Stepper 组件
- 最小数量: 1
- 最大数量: 99

### 4. 加入购物车
- 校验所有必选规格是否已选
- 构造 CartItem 对象
- 调用 cartStore.addItem() 添加到购物车
- 支持游客购物车和用户购物车
- 成功后自动返回菜单页

### 5. 想要/到货提醒 (售罄状态)
- 售罄商品显示 "想要" 按钮
- 需要登录
- 调用 API 记录用户想要
- 商品到货后后端推送通知

## 技术实现

### 状态管理
- 使用 MobX 的 `menuStore` 获取商品数据
- 使用 MobX 的 `cartStore` 管理购物车状态
- 页面内部 data 管理:
  - `selectedSpecs`: 已选规格 Map
  - `quantity`: 购买数量
  - `displayPrice`: 当前显示价格
  - `isSoldOut`: 是否售罄

### 价格计算逻辑
```typescript
displayPrice = base_price + Σ(selected_spec.price_modifier)
totalPrice = displayPrice * quantity
```

### 购物车项唯一标识
```typescript
itemKey = `${product_id}_${sorted_spec_option_ids.join('-')}`
```

相同商品+相同规格组合会累加数量，不同规格组合会作为独立项目。

## 样式设计

### CSS 变量使用
- `--primary-color`: 主题色 (选中状态、价格)
- `--font-size-*`: 字体大小
- `--text-color`: 文本颜色
- `--bg-color`: 背景色
- `--border-radius`: 圆角

### 适老化支持
- 所有尺寸使用 CSS 变量
- 支持字体放大
- 触控区域不小于 88rpx

### 响应式布局
- 底部操作栏固定
- 内容区域支持滚动
- 避免内容被底部栏遮挡

## API 依赖

### 菜单 API
- `GET /api/v1/menu` - 获取菜单数据 (通过 menuStore)

### 想要 API
- `POST /api/v1/products/{id}/want` - 添加想要记录

## 数据流

```
用户进入页面
  ↓
从 menuStore 加载商品数据 (带缓存)
  ↓
用户选择规格 → 实时计算价格
  ↓
用户调整数量 → 更新总价显示
  ↓
用户点击加入购物车
  ↓
校验规格完整性
  ↓
构造 CartItem → cartStore.addItem()
  ↓
本地存储持久化 (区分游客/用户)
  ↓
Toast 提示 → 返回菜单页
```

## 错误处理

### 商品不存在
- Toast 提示 "商品不存在"
- 自动返回上一页

### 加载失败
- Toast 提示 "加载失败"
- 允许用户重试

### 规格未选全
- Toast 提示 "请选择XXX"
- 不允许加入购物车

### 售罄规格选择
- Toast 提示 "该规格已售罄"
- 阻止选择

### 想要功能未登录
- Modal 提示 "此功能需要登录，是否前往登录?"
- 确认后跳转到个人中心

## 测试要点

### 功能测试
- [ ] 商品信息正确显示
- [ ] 规格选择正常，价格动态计算正确
- [ ] 售罄规格无法选择并有提示
- [ ] 数量选择正常 (1-99 范围)
- [ ] 规格未选全时无法加入购物车并有提示
- [ ] 加入购物车后数据正确存储
- [ ] 售罄商品显示"想要"按钮
- [ ] 想要功能正常 (登录/未登录场景)

### 边界测试
- [ ] 无图片商品显示占位图
- [ ] 无规格商品直接加入购物车
- [ ] 所有规格售罄的商品
- [ ] 部分规格售罄的商品
- [ ] 游客购物车与用户购物车切换

### UI 测试
- [ ] 适配不同屏幕尺寸
- [ ] 适老化主题切换
- [ ] 加载状态正确显示
- [ ] 底部操作栏不遮挡内容

## 依赖组件

### Vant Weapp
- `van-loading` - 加载指示器
- `van-icon` - 图标
- `van-button` - 按钮
- `van-stepper` - 数量选择器

### 自定义组件
无

## 文件清单

```
pages/product-detail/
├── product-detail.ts       # 页面逻辑
├── product-detail.wxml     # 页面结构
├── product-detail.wxss     # 页面样式
├── product-detail.json     # 页面配置
└── README.md               # 本文档
```

## 后续优化

### 性能优化
- [ ] 商品图片懒加载
- [ ] 图片使用 CDN
- [ ] 规格选择防抖

### 功能增强
- [ ] 商品图片轮播
- [ ] 商品详情富文本展示
- [ ] 营养成分表
- [ ] 用户评价
- [ ] 相关商品推荐
- [ ] 购物车悬浮球显示数量

### 交互优化
- [ ] 规格选择动画效果
- [ ] 加入购物车抛物线动画
- [ ] 骨架屏加载
